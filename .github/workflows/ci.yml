name: ci

on:
  push:
    branches: ['main']
  workflow_dispatch:

permissions:
  contents: write          
  packages: write
  actions: read

env:
  CARGO_TERM_COLOR: always
  DEBIAN_FRONTEND: noninteractive

jobs:
  build:
    name: Build Debian Package
    runs-on: ubuntu-latest
    timeout-minutes: 30
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          fetch-depth: 0

      - name: Install system deps
        run: |
          sudo apt-get update
          sudo apt-get install -y --no-install-recommends \
            build-essential pkg-config libssl-dev ca-certificates \
            fakeroot debhelper devscripts jq curl file

      - name: Set up Rust (stable)
        uses: dtolnay/rust-toolchain@6d653acede28d24f02e3cd41383119e8b1b35921
        with:
          toolchain: stable

      - name: Cargo build (release)
        run: cargo build --release

      - name: Cargo test
        run: cargo test --all --all-features --verbose

      - name: Install cargo-deb
        run: cargo install cargo-deb --locked

      - name: Build .deb package
        run: |
          cargo deb --no-strip
          mkdir -p dist
          DEB=$(ls target/debian/*.deb | head -n1)
          test -f "$DEB" || { echo "No .deb produced"; exit 1; }
          VER=$(dpkg-deb -f "$DEB" Version | sed 's/~/-/g')
          OUT="dist/hardn_${VER}_amd64.deb"
          cp -f "$DEB" "$OUT"
          echo "Built: $OUT"
          echo "deb_path=$OUT" >> $GITHUB_OUTPUT
          echo "deb_name=$(basename "$OUT")" >> $GITHUB_OUTPUT
        id: deb

      - name: Upload .deb artifact
        uses: actions/upload-artifact@b4b15b8c7c6ac21ea08fcf65892d2ee8f75cf882
        with:
          name: hardn-deb
          path: dist/*.deb

  release:
    name: Create Release
    needs: [build]
    runs-on: ubuntu-latest
    timeout-minutes: 15
    steps:
      - name: Checkout
        uses: actions/checkout@11bd71901bbe5b1630ceea73d27597364c9af683
        with:
          fetch-depth: 0

      - name: Download .deb artifact
        uses: actions/download-artifact@fa0a91b85d4f404e444e00e005971372dc801d16
        with:
          name: hardn-deb
          path: release_assets

      - name: Get version for semantic tagging
        id: version
        run: |
          DEB_FILE=$(ls release_assets/*.deb | head -n1)
          VERSION=$(dpkg-deb -f "$DEB_FILE" Version | sed 's/~/-/g')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "Version extracted: $VERSION"

      - name: Create semantic version tag
        id: tag
        run: |
          VERSION="${{ steps.version.outputs.version }}"
          # Create semantic version tag (patch level bump)
          if git tag --list | grep -q "^v"; then
            LATEST_TAG=$(git tag --list "v*" | sort -V | tail -n1)
            if [ -n "$LATEST_TAG" ]; then
              # Bump patch version
              NEW_TAG=$(echo "$LATEST_TAG" | awk -F. '{print $1"."$2"."($3+1)}')
            else
              NEW_TAG="v${VERSION}"
            fi
          else
            NEW_TAG="v${VERSION}"
          fi
          echo "new_tag=$NEW_TAG" >> $GITHUB_OUTPUT
          echo "Creating tag: $NEW_TAG"

      - name: Push tag
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag "${{ steps.tag.outputs.new_tag }}"
          git push origin "${{ steps.tag.outputs.new_tag }}"

      - name: Generate release notes
        id: notes
        run: |
          TAG="${{ steps.tag.outputs.new_tag }}"
          REPO="${{ github.repository }}"
          
          cat > RELEASE_NOTES.md << 'EOF'
          ![HARDN Logo](docs/IMG_1233.jpeg)

          # HARDN ${TAG}

          Latest release of HARDN security toolkit with Debian package.

          ## Installation

          ### Debian/Ubuntu
          ```bash
          # Download the latest release
          wget https://github.com/${REPO}/releases/download/${TAG}/hardn_amd64.deb
          
          # Install the package
          sudo dpkg -i hardn_amd64.deb
          
          # Fix any missing dependencies
          sudo apt-get install -f
          
          # Verify installation
          hardn --version
          ```

          ## What's Included

          - **hardn_amd64.deb** - Debian package for x86_64 systems
          - Pre-compiled binary with all security monitoring features
          - Systemd service integration
          - Comprehensive security monitoring with ML-powered anomaly detection

          ## Features

          - Legion: Advanced security monitoring with behavioral analysis
          - Threat intelligence integration
          - Automated incident response
          - Real-time risk scoring
          - REST API with SSH-RSA authentication

          _Note: This release includes source archives automatically generated by GitHub._
          EOF

      - name: Create GitHub Release
        uses: softprops/action-gh-release@c062e08bd532815e2082a85e87e3ef29c3e6d191
        with:
          name: HARDN 
          body_path: RELEASE_NOTES.md
          files: release_assets/*.deb
          draft: false
          prerelease: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
